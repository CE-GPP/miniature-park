<!doctype html>
<html>
<head>
	<title>QEOP Map</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />


	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	<link href="Leaflet.Weather.css" rel="stylesheet" type="text/css" />
	<!-- <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->
    <script src="heatmap.js"></script>
    <script src="leaflet-heatmap.js"></script>

	<script src='https://www.unpkg.com/suncalc@1.9.0/suncalc.js'></script>
	<script src="https://unpkg.com/leaflet-shadow-simulator/dist/leaflet-shadow-simulator.umd.min.js"></script>
    <link rel="stylesheet" href="OSMBuildings.css">
    <script src="OSMBuildings-Leaflet.debug.js"></script>
	<script src="smoothWheelZoom.js"></script>
	<!-- <script src="mqtt.js" type="module"></script> -->
	
	
</head>
<body>

<div id="map"></div>


<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<!-- <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://npmcdn.com/leaflet@1.0.3/dist/leaflet.js"></script> -->


<script src="../dist/leaflet-velocity.js"></script>

<!--demo-->
<!-- <link rel="stylesheet" href="demo.css" /> -->

<script src="Leaflet.Weather.js"></script>

<script src="santanderBike.js"></script>

<script type="module"> //type="module"
	var map = L.map('map', { zoomControl: false, 
						scrollWheelZoom: false,
        				smoothWheelZoom: true,
        				smoothSensitivity: 1,
					}).setView([51.5442, 0.0159], 16.5);
	map.scrollWheelZoom = true;

	L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
			attribution:
				'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
			maxZoom: 18,
		}).addTo(map);

		
		window.onload = async function() {

			async function loadJSON (url) {
  				const res = await fetch(url);
  				return await res.json();
			}


  			var csv = await loadJSON ('https://raw.githubusercontent.com/Naomi1122/minipark/main/csvjson.json');
			
  			//console.log(csv)
  			var testData = {
	  			max: 200,
	  			data: csv
  			};

  			heatmapLayer.setData(testData);
		};
		var OpenstreetMap = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
			attribution:
				'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
		});
		var Esri_DarkGreyCanvas = L.tileLayer(
        "http://{s}.sm.mapstack.stamen.com/" +
        "(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/" +
        "{z}/{x}/{y}.png",
        {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, ' +
            'NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
        }
    	);
		var baseLayer = {
        "Satellite": OpenstreetMap, "Grey Canvas": Esri_DarkGreyCanvas
    	};

		const osmb = new OSMBuildings();
  		//osmb.addTo(map);

  		osmb.load('https://{s}-data.3dbuildings.com/tile/{z}/{x}/{y}.json?token=xsthpfc');
  		//osmb.load();
		

		var cfg = {
  			// radius should be small ONLY if scaleRadius is true (or small radius is intended)
  			"radius": 0.001,
  			"maxOpacity": .8, 
  			// scales the radius based on map zoom
  			"scaleRadius": true, 
  			// if set to false the heatmap uses the global maximum for colorization
  			// if activated: uses the data maximum within the current map boundaries 
  			//   (there will always be a red spot with useLocalExtremas true)
  			"useLocalExtrema": true,
  			// which field name in your data represents the latitude - default "lat"
 			latField: 'Latitude',
  			// which field name in your data represents the longitude - default "lng"
  			lngField: 'Longitude',
  			// which field name in your data represents the data value - default "value"
  			valueField: 'Mediandown load speed'
		};


		var heatmapLayer = new HeatmapOverlay(cfg);


		var layerControl = L.control.layers(baseLayer, null, {collapsed:false}).addTo(map);
		layerControl.addOverlay(heatmapLayer, "Coverage");
		layerControl.addOverlay(osmb, "Buildings");

		var datav;

			$.ajaxSettings.async = false;

			$.getJSON("wind-global.json", function(data) {
  				datav = data;

		});
		$.ajaxSettings.async = true;
			
		var velocityLayer = L.velocityLayer({
    			displayValues: true,
    			displayOptions: {
      			velocityType: "Global Wind",
      			position: "bottomleft",
      			emptyString: "No wind data"
    			},
    			data: datav,
    			maxVelocity: 15
  			});

  			layerControl.addOverlay(velocityLayer, "Wind - Global");

		var weatherControl = new L.Control.Weather();
		// if (!(map.hasLayer(Esri_DarkGreyCanvas)))
		//map.addControl(weatherControl);

		
		/* ShadeMap setup */
		//var date = new Date(); // Or the date you'd like converted.
		//var isoDateTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString();
		const loaderEl = document.getElementById('loader');
		let now = new Date();//1633358583454
		var shadeMap1 = L.shadeMap({
			apiKey: "eyJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImouY2hlMThAeWFob28uY29tIiwiY3JlYXRlZCI6MTY3OTMyNTE1OTk3MywiaWF0IjoxNjc5MzI1MTU5fQ.5WjgkL9uyi7L1tmEtdBvw_tu4r-BTElt-KfPyR9oQQk",
			date: now,
			color: '#01112f',
			opacity: 0.7,
			terrainSource: {
				maxZoom: 15,
				tileSize: 256,
				getSourceUrl: ({ x, y, z }) => `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${z}/${x}/${y}.png`,
				getElevation: ({ r, g, b, a }) => (r * 256 + g + b / 256) - 32768,
			},
			debug: (msg) => { console.log(new Date().toISOString(), msg) }
		});

		shadeMap1.on('tileloaded', (loadedTiles, totalTiles) => {
			//loaderEl.innerText = `Loading: ${(loadedTiles / totalTiles * 100).toFixed(0)}%`;
		});

		shadeMap1.setDate(new Date(Date.now() )); 
		//shadeMap.setDate(new Date(isoDateTime + 6000 * 60 * 60)); //+ 1000 * 60 * 60
		//console.log(date);
		//layerControl.addOverlay(shadeMap, "Shade");
		//console.log("shade removed")
		// console.log(getMethods(shadeMap1).join("\n \n"));
		//console.log(shadeMap1.setOpacity(0.7))
		// function getMethods(obj) {
		// 	var result = [];
		// 	for (var id in obj) {
		// 		try {
		// 		if (typeof(obj[id]) == "function") {
		// 			result.push(id + ": " + obj[id].toString());
		// 		}
		// 		} catch (err) {
		// 		result.push(id + ": inaccessible");
		// 		}
		// 	}
		// 	return result;
		// 	}


		/* End ShadeMap setup */
		//loadBikes();
		
		var markerLayer = L.layerGroup();
		//console.log(markerLayer);
		loadBikes(markerLayer);
		layerControl.addOverlay(markerLayer, "Bike Stations");
		
	var base = "";
    var over = "";
    var result;
	console.log("Hello")
    async function fetchLatestMessage() {
        await fetch("http://localhost:3000/latest-message")
        .then(response => {
            return response.json();
        })
        .then(({topic, message}) => {
            //console.log(message)
          if (topic && message) {
            if (topic == 'student/ucfnimx/QEOPMap/style'){
                base = message;
                //console.log(base)
                // return base;
            }else{
                over = message
            }
          }
        })
    }

    await setInterval(async function() { 
		await fetchLatestMessage();
		console.log("result is:")
    	// console.log(base);
		if(base !== ""){
			for (var key of Object.keys(base)) {
				if (base[key] === true){
					//console.log(key)
					switch(key){
						case "Satellite":
							//Esri_DarkGreyCanvas.remove()
							OpenstreetMap.addTo(map)
							break;
						case "Grey":
							//OpenstreetMap.remove()
							console.log(base);
							Esri_DarkGreyCanvas.addTo(map)
							//console.log(map)
							break;
						
					}	
				}else if(base[key] === false){
					switch(key){
						case "Satellite":
							OpenstreetMap.remove()
							break;
						case "Grey":
							Esri_DarkGreyCanvas.remove()
							break;
						
					}
				} 
			}
			base = ""
		}else if(over !== ""){
			for (var key of Object.keys(over)) {
					if (over[key] === true){
						console.log(key);
						switch(key){
							case "weather":
								map.addControl(weatherControl)
								break;
							case "heatmapLayer":
								heatmapLayer.addTo(map)
								break;
							case "osmb":
								osmb.addTo(map)
								break;
							case "shadeMap":
								shadeMap1.addTo(map);
								shadeMap1.setOpacity(0.7);
								break;
							case "markerLayer":
								markerLayer.addTo(map)
								break;
							case "Wind":
								velocityLayer.addTo(map)
								break;	
						}	
					}else if(over[key] === false){
						switch(key){
							case "weather":
								weatherControl.remove()
								break;
							case "heatmapLayer":
								heatmapLayer.remove()
								break;
							case "osmb":
								osmb.remove()
								break;
							case "shadeMap":
								shadeMap1.setOpacity(0);
								break;
							case "markerLayer":
								markerLayer.remove()
								break;
							case "Wind":
								velocityLayer.remove()
								break;	
						}	
					} 
				}
				over = ""
		}

		
	}, 2000);

	
</script>


</body>
</html>
