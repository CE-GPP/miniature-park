<!doctype html>
<html>
<head>
	<title>QEOP Map</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />


	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	<link href="Leaflet.Weather.css" rel="stylesheet" type="text/css" />
	<!-- <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->
    <script src="heatmap.js"></script>
    <script src="leaflet-heatmap.js"></script>

	<script src='https://www.unpkg.com/suncalc@1.9.0/suncalc.js'></script>
	<script src="leaflet-shadow-simulator.umd.min.js"></script>
    <link rel="stylesheet" href="OSMBuildings.css">
    <script src="OSMBuildings-Leaflet.debug.js"></script>
	<!-- <script src="mqtt.js" type="module"></script> -->
	
	
</head>
<body>

<div id="map"></div>


<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<!-- <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://npmcdn.com/leaflet@1.0.3/dist/leaflet.js"></script> -->


<script src="/dist/leaflet-velocity.js"></script>

<!--demo-->
<!-- <link rel="stylesheet" href="demo.css" /> -->

<script src="Leaflet.Weather.js"></script>

<script src="santanderBike.js"></script>

<script>
	var map = L.map('map', { zoomControl: false }).setView([51.5442, 0.0159], 15);

	L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
			attribution:
				'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
			maxZoom: 18,
		}).addTo(map);

		
		window.onload = async function() {

			async function loadJSON (url) {
  				const res = await fetch(url);
  				return await res.json();
			}


  			var csv = await loadJSON ('https://raw.githubusercontent.com/Naomi1122/minipark/main/csvjson.json');
			
  			//console.log(csv)
  			var testData = {
	  			max: 200,
	  			data: csv
  			};

  			heatmapLayer.setData(testData);
		};
		var Esri_WorldImagery = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
			maxZoom: 18
  			});
		var Esri_DarkGreyCanvas = L.tileLayer(
        "http://{s}.sm.mapstack.stamen.com/" +
        "(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/" +
        "{z}/{x}/{y}.png",
        {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, ' +
            'NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
        }
    	);
		var baseLayer = {
        "Satellite": Esri_WorldImagery, "Grey Canvas": Esri_DarkGreyCanvas
    	};

		const osmb = new OSMBuildings();
  		//osmb.addTo(map);

  		// osmb.load('https://{s}-data.3dbuildings.com/tile/{z}/{x}/{y}.json?token=xsthpfc');
  		osmb.load();
		

		var cfg = {
  			// radius should be small ONLY if scaleRadius is true (or small radius is intended)
  			"radius": 0.0007,
  			"maxOpacity": .65, 
  			// scales the radius based on map zoom
  			"scaleRadius": true, 
  			// if set to false the heatmap uses the global maximum for colorization
  			// if activated: uses the data maximum within the current map boundaries 
  			//   (there will always be a red spot with useLocalExtremas true)
  			"useLocalExtrema": true,
  			// which field name in your data represents the latitude - default "lat"
 			latField: 'Latitude',
  			// which field name in your data represents the longitude - default "lng"
  			lngField: 'Longitude',
  			// which field name in your data represents the data value - default "value"
  			valueField: 'Mediandown load speed'
		};


		var heatmapLayer = new HeatmapOverlay(cfg);


		var layerControl = L.control.layers(baseLayer, null, {collapsed:false}).addTo(map);
		layerControl.addOverlay(heatmapLayer, "Coverage");
		layerControl.addOverlay(osmb, "Buildings");

		var datav;

			$.ajaxSettings.async = false;

			$.getJSON("wind-global.json", function(data) {
  				datav = data;

		});
		$.ajaxSettings.async = true;
			
		var velocityLayer = L.velocityLayer({
    			displayValues: true,
    			displayOptions: {
      			velocityType: "Global Wind",
      			position: "bottomleft",
      			emptyString: "No wind data"
    			},
    			data: datav,
    			maxVelocity: 15
  			}).addTo(map);

  			layerControl.addOverlay(velocityLayer, "Wind - Global");

		var weatherControl = new L.Control.Weather();
		// if (!(map.hasLayer(Esri_DarkGreyCanvas)))
		map.addControl(weatherControl);

		
		/* ShadeMap setup */
		const loaderEl = document.getElementById('loader');
		let now = new Date();//1633358583454
		const shadeMap = L.shadeMap({
			apiKey: "eyJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImouY2hlMThAeWFob28uY29tIiwiY3JlYXRlZCI6MTY3OTMyNTE1OTk3MywiaWF0IjoxNjc5MzI1MTU5fQ.5WjgkL9uyi7L1tmEtdBvw_tu4r-BTElt-KfPyR9oQQk",
			date: now,
			color: '#01112f',
			opacity: 0.7,
			terrainSource: {
				maxZoom: 15,
				tileSize: 256,
				getSourceUrl: ({ x, y, z }) => `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${z}/${x}/${y}.png`,
				getElevation: ({ r, g, b, a }) => (r * 256 + g + b / 256) - 32768,
			},
			getFeatures: async () => {
					await mapLoaded(map);
					const buildingData = map.querySourceFeatures('composite', { sourceLayer: 'building' }).filter((feature) => {
						return feature.properties && feature.properties.underground !== "true" && (feature.properties.height || feature.properties.render_height)
					});
					return buildingData;
				},
			debug: (msg) => { console.log(new Date().toISOString(), msg) }
		}).addTo(map);

		shadeMap.on('tileloaded', (loadedTiles, totalTiles) => {
			loaderEl.innerText = `Loading: ${(loadedTiles / totalTiles * 100).toFixed(0)}%`;
		});

		shadeMap.setDate(new Date(Date.now() + 1000 * 60 * 60));
		//layerControl.addOverlay(shadeMap, "Shade");
		
		/* End ShadeMap setup */
		
		var markerLayer = L.layerGroup();
		loadBikes();
		layerControl.addOverlay(markerLayer, "Bike Stations");
		
		// console.log(mqttResponse)
  		controlJson = {Satellite: "false", GreyCanvas:"true", heatmapLayer: "false", osmb: "false", shadeMap: "false", markerLayer: "true", Wind: "true"};
		
		//remove every layer
		//map.removeLayer();
		for (var key of Object.keys(controlJson)) {
			if (controlJson[key] === 'true'){
				switch(key){
					case "Satellite":
						Esri_WorldImagery.addTo(map)
						break;
					case "GreyCanvas":
						Esri_DarkGreyCanvas.addTo(map)
						break;
					case "heatmapLayer":
						heatmapLayer.addTo(map)
						break;
					case "osmb":
						osmb.addTo(map)
						break;
					case "shadeMap":
						shadeMap.addTo(map)
						break;
					case "markerLayer":
						markerLayer.addTo(map)
						break;
					case "Wind":
					    velocityLayer.addTo(map)
						break;	
				}	
			} 
		}

			
</script>


</body>
</html>
